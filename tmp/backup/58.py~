import requests
import time
import pymysql
from lxml import etree

db = pymysql.connect(host = '127.0.0.1',port=3306,user='root',password='903108759',database="mydb")

cursor = db.cursor()

headers = {'user-agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36'}

base_page_url = 'https://cn.58.com/ershoufang/p'

def parse_detail(detail_url):
    detail_resp=requests.get(detail_url,headers=headers)
    detail_text=detail_resp.text
    detail_parser=etree.HTML(detail_text)
    title=detail_parser.xpath("//div[@class='banner-title']/h1[@class='title']/text()")[0]
    code=detail_parser.xpath("//div[@class='banner-title']/div[@class='banner-title-code']/text()")[0]
    price=detail_parser.xpath("//div[@class='props-right']//div[@class='maininfo-price']/div[@class='maininfo-price-wrap']/span/text()")[0]
    area=detail_parser.xpath("//div[@class='maininfo-model']/div[@class='maininfo-model-item maininfo-model-item-2']/div[@class='maininfo-model-strong']/i/text()")[0]
    house_type_list=detail_parser.xpath("//div[@class='maininfo-model']/div[@class='maininfo-model-item maininfo-model-item-1']/div[@class='maininfo-model-strong']/*/text()")
    house_type=''
    for char in house_type_list:
        house_type+=char
    print(code,title,price,area,house_type)
    print()
    sql = "insert into house_test(id,title,code,price,area,houseType)values(null,%s,%s,%s,%s,%s)"
    cursor.execute(sql,(title,code,price[0],str(area),house_type))


def parse_page(page_url):
    save = 0
    resp=requests.get(page_url,headers=headers)
    text=resp.text
    parser=etree.HTML(text)
    detail_urls=parser.xpath("//section[@class='list']/div[@class='property']/a/@href")
    for detail_url in detail_urls:
        time.sleep(10)
        parse_detail(detail_url)
        save+=1
        if(save%3==0):
            db.commit()

def main():
    for page in range(1,3):
        page_url= base_page_url+str(page)+'/'
        parse_page(page_url)

if __name__ == "__main__":
    main()
    db.commit()
    db.close()


